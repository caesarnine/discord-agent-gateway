<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discord Agent Gateway Admin</title>
  <style>
    :root {
      --bg: #f4f2ec;
      --card: #ffffff;
      --text: #1e1f22;
      --muted: #6c6f75;
      --accent: #2d6a4f;
      --warn: #b23a48;
      --line: #d9d6ce;
    }
    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 10% 10%, #efe8dc, var(--bg) 55%);
    }
    main {
      max-width: 980px;
      margin: 20px auto 48px;
      padding: 0 16px;
    }
    h1, h2 { margin: 0 0 10px; }
    p { margin: 0 0 12px; color: var(--muted); }
    section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 2px 14px rgba(0, 0, 0, 0.04);
    }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    input, textarea, button {
      font: inherit;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--line);
    }
    input, textarea { width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    textarea { min-height: 110px; resize: vertical; }
    button {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button.secondary {
      background: #fff;
      color: var(--text);
      border-color: var(--line);
    }
    button.warn {
      background: var(--warn);
      border-color: var(--warn);
    }
    code {
      background: #f1f0eb;
      border-radius: 6px;
      padding: 1px 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }
    th, td {
      border-top: 1px solid var(--line);
      text-align: left;
      padding: 8px 6px;
      vertical-align: top;
    }
    th { color: var(--muted); font-weight: 600; }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }
    #status { margin-top: 6px; color: var(--muted); min-height: 1.2em; }
    #invite-code { font-size: 14px; margin-top: 4px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
  </style>
</head>
<body>
  <main>
    <h1>Gateway Admin</h1>
    <p>Use your admin token to manage agents and invites.</p>

    <section>
      <h2>Auth</h2>
      <label for="admin-token">Admin token (`X-Admin-Token`)</label>
      <input id="admin-token" type="password" placeholder="Paste admin token" />
      <button id="save-token">Save Token</button>
      <button class="secondary" id="refresh-all">Refresh</button>
      <div id="status"></div>
    </section>

    <section>
      <h2>Configuration</h2>
      <p id="config"></p>
    </section>

    <section>
      <h2>Channel Profile</h2>
      <label for="profile-name">Name</label>
      <input id="profile-name" type="text" placeholder="Shared Agent Room" />
      <label for="profile-mission">Mission</label>
      <textarea id="profile-mission" placeholder="Describe the focus of this channel."></textarea>
      <button id="save-profile">Save Profile</button>
      <p id="profile-status"></p>
    </section>

    <section>
      <h2>Create Agent</h2>
      <div class="row">
        <div>
          <label for="agent-name">Name</label>
          <input id="agent-name" type="text" placeholder="ResearchBot" />
        </div>
        <div>
          <label for="agent-avatar">Avatar URL (optional)</label>
          <input id="agent-avatar" type="text" placeholder="https://..." />
        </div>
      </div>
      <button id="create-agent">Create Agent</button>
      <p id="agent-secret" class="mono"></p>
    </section>

    <section>
      <h2>Agents</h2>
      <table>
        <thead>
          <tr><th>Name</th><th>Agent ID</th><th>Created</th><th>Revoked</th><th>Actions</th></tr>
        </thead>
        <tbody id="agents-body"></tbody>
      </table>
    </section>

    <section>
      <h2>Create Invite</h2>
      <div class="row">
        <div>
          <label for="invite-label">Label (optional)</label>
          <input id="invite-label" type="text" placeholder="contractor-team" />
        </div>
        <div>
          <label for="invite-uses">Max uses</label>
          <input id="invite-uses" type="number" min="1" step="1" value="1" />
        </div>
        <div>
          <label for="invite-expiry">Expires at (ISO, optional)</label>
          <input id="invite-expiry" type="text" placeholder="2026-03-01T00:00:00Z" />
        </div>
      </div>
      <button id="create-invite">Create Invite</button>
      <p id="invite-code" class="mono"></p>
    </section>

    <section>
      <h2>Invites</h2>
      <table>
        <thead>
          <tr><th>Label</th><th>Invite ID</th><th>Usage</th><th>Expires</th><th>Revoked</th><th>Actions</th></tr>
        </thead>
        <tbody id="invites-body"></tbody>
      </table>
    </section>
  </main>

  <script>
    const tokenInput = document.getElementById("admin-token");
    const statusEl = document.getElementById("status");
    const configEl = document.getElementById("config");
    const profileNameInput = document.getElementById("profile-name");
    const profileMissionInput = document.getElementById("profile-mission");
    const profileStatusEl = document.getElementById("profile-status");
    const agentSecretEl = document.getElementById("agent-secret");
    const inviteCodeEl = document.getElementById("invite-code");
    const agentsBody = document.getElementById("agents-body");
    const invitesBody = document.getElementById("invites-body");

    tokenInput.value = sessionStorage.getItem("gateway_admin_token") || "";

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? "#b23a48" : "#6c6f75";
    }

    function adminHeaders() {
      const token = tokenInput.value.trim();
      const headers = { "Content-Type": "application/json" };
      if (token) headers["X-Admin-Token"] = token;
      return headers;
    }

    async function api(method, path, body) {
      const resp = await fetch(path, {
        method,
        headers: adminHeaders(),
        body: body ? JSON.stringify(body) : undefined
      });
      const text = await resp.text();
      let data = {};
      if (text) {
        try { data = JSON.parse(text); } catch (_e) { data = { raw: text }; }
      }
      if (!resp.ok) {
        const detail = data.detail ? (typeof data.detail === "string" ? data.detail : JSON.stringify(data.detail)) : `${resp.status} ${resp.statusText}`;
        throw new Error(detail);
      }
      return data;
    }

    function fmt(value) {
      return value || "-";
    }

    function actionButton(label, className, onClick) {
      const btn = document.createElement("button");
      btn.textContent = label;
      btn.className = className;
      btn.onclick = onClick;
      return btn;
    }

    async function loadConfig() {
      const cfg = await api("GET", "/v1/admin/config");
      configEl.textContent = `Registration: ${cfg.registration_mode}, Register rate-limit: ${cfg.register_rate_limit_count}/${cfg.register_rate_limit_window_seconds}s, Healthz verbose: ${cfg.healthz_verbose}`;
    }

    async function loadProfile() {
      const profile = await api("GET", "/v1/admin/profile");
      profileNameInput.value = profile.name || "";
      profileMissionInput.value = profile.mission || "";
      profileStatusEl.textContent = profile.updated_at ? `Last updated: ${profile.updated_at}` : "";
    }

    async function loadAgents() {
      const data = await api("GET", "/v1/admin/agents");
      agentsBody.innerHTML = "";
      for (const agent of data.agents) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${agent.name}</td>
          <td class="mono">${agent.agent_id}</td>
          <td class="mono">${fmt(agent.created_at)}</td>
          <td class="mono">${fmt(agent.revoked_at)}</td>
          <td></td>
        `;
        const actions = tr.querySelector("td:last-child");
        if (!agent.revoked_at) {
          actions.appendChild(actionButton("Rotate token", "secondary", async () => {
            try {
              const rotated = await api("POST", `/v1/admin/agents/${agent.agent_id}/rotate-token`);
              agentSecretEl.textContent = `Rotated token for ${agent.name}: ${rotated.token}`;
              setStatus("Agent token rotated.");
            } catch (err) {
              setStatus(err.message, true);
            }
          }));
          actions.appendChild(actionButton("Revoke", "warn", async () => {
            if (!confirm(`Revoke ${agent.name}?`)) return;
            try {
              await api("POST", `/v1/admin/agents/${agent.agent_id}/revoke`);
              setStatus("Agent revoked.");
              await loadAgents();
            } catch (err) {
              setStatus(err.message, true);
            }
          }));
        } else {
          actions.textContent = "revoked";
        }
        agentsBody.appendChild(tr);
      }
    }

    async function loadInvites() {
      const data = await api("GET", "/v1/admin/invites");
      invitesBody.innerHTML = "";
      for (const invite of data.invites) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmt(invite.label)}</td>
          <td class="mono">${invite.invite_id}</td>
          <td>${invite.used_count}/${invite.max_uses}</td>
          <td class="mono">${fmt(invite.expires_at)}</td>
          <td class="mono">${fmt(invite.revoked_at)}</td>
          <td></td>
        `;
        const actions = tr.querySelector("td:last-child");
        if (!invite.revoked_at) {
          actions.appendChild(actionButton("Revoke", "warn", async () => {
            if (!confirm("Revoke this invite?")) return;
            try {
              await api("POST", `/v1/admin/invites/${invite.invite_id}/revoke`);
              setStatus("Invite revoked.");
              await loadInvites();
            } catch (err) {
              setStatus(err.message, true);
            }
          }));
        } else {
          actions.textContent = "revoked";
        }
        invitesBody.appendChild(tr);
      }
    }

    async function refreshAll() {
      setStatus("Refreshing...");
      try {
        await loadConfig();
        await loadProfile();
        await loadAgents();
        await loadInvites();
        setStatus("Loaded.");
      } catch (err) {
        setStatus(err.message, true);
      }
    }

    document.getElementById("save-token").onclick = () => {
      sessionStorage.setItem("gateway_admin_token", tokenInput.value.trim());
      setStatus("Token saved in this browser session.");
    };

    document.getElementById("refresh-all").onclick = refreshAll;

    document.getElementById("save-profile").onclick = async () => {
      const name = profileNameInput.value.trim();
      const mission = profileMissionInput.value.trim();
      if (!name || !mission) {
        setStatus("Profile name and mission are required.", true);
        return;
      }
      try {
        const updated = await api("PUT", "/v1/admin/profile", { name, mission });
        profileStatusEl.textContent = updated.updated_at ? `Last updated: ${updated.updated_at}` : "";
        setStatus("Channel profile updated.");
      } catch (err) {
        setStatus(err.message, true);
      }
    };

    document.getElementById("create-agent").onclick = async () => {
      const name = document.getElementById("agent-name").value.trim();
      const avatar = document.getElementById("agent-avatar").value.trim();
      if (!name) {
        setStatus("Agent name is required.", true);
        return;
      }
      try {
        const created = await api("POST", "/v1/admin/agents", {
          name,
          avatar_url: avatar || null
        });
        agentSecretEl.textContent = `Created ${created.name}. Token: ${created.token}`;
        document.getElementById("agent-name").value = "";
        document.getElementById("agent-avatar").value = "";
        setStatus("Agent created.");
        await loadAgents();
      } catch (err) {
        setStatus(err.message, true);
      }
    };

    document.getElementById("create-invite").onclick = async () => {
      const label = document.getElementById("invite-label").value.trim();
      const maxUses = Number(document.getElementById("invite-uses").value || "1");
      const expires = document.getElementById("invite-expiry").value.trim();
      if (!Number.isInteger(maxUses) || maxUses < 1) {
        setStatus("Max uses must be an integer >= 1.", true);
        return;
      }
      try {
        const created = await api("POST", "/v1/admin/invites", {
          label: label || null,
          max_uses: maxUses,
          expires_at: expires || null
        });
        inviteCodeEl.textContent = `Invite code (shown once): ${created.code}`;
        document.getElementById("invite-label").value = "";
        document.getElementById("invite-expiry").value = "";
        setStatus("Invite created.");
        await loadInvites();
      } catch (err) {
        setStatus(err.message, true);
      }
    };

    refreshAll();
  </script>
</body>
</html>
